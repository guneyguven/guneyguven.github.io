<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Tango — Neo / NeoKlasik / Klasik (Mobil Uyumlu)</title>
<style>
  :root{
    /* Varsayılan (Neo) — JS ile değişir */
    --bg:#0f1220; --panel:#171a2b; --text:#e6e7ee; --muted:#9aa0b6;
    --accent:#7dd3fc; --accent2:#a78bfa; --glass:rgba(255,255,255,.06);
    --shadow:0 8px 24px rgba(0,0,0,.35); --radius:14px;
    --grid-line:rgba(255,255,255,.06); --grid-bg1:rgba(255,255,255,.05); --grid-bg2:rgba(255,255,255,.01);
    --block-border:rgba(255,255,255,.25);
    --block-flat:#9bdcff; --block-flat2:#6aa0ff; --glow:rgba(125,211,252,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0b0e1d;color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  #wrap{position:relative;width:100%;height:100%;}
  canvas{display:block;width:100%;height:100%;touch-action:none}

  /* HUD */
  .hud{
    position:absolute;left:16px;top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    padding:10px 12px;background:var(--glass);backdrop-filter:blur(6px);
    border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.08);
  }
  .stat{font-weight:600}
  .muted{color:var(--muted)}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.35)}
  .btn{
    cursor:pointer;user-select:none;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));box-shadow:var(--shadow)
  }
  .toolbar{
    position:absolute;right:16px;top:16px;display:flex;gap:10px;align-items:center;
    padding:10px 12px;background:var(--glass);backdrop-filter:blur(6px);
    border-radius:var(--radius);border:1px solid rgba(255,255,255,.08);
  }
  select{
    appearance:none;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);color:var(--text)
  }
  .centerNote{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    padding:14px 18px;background:var(--glass);border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;display:none
  }
  .footer{
    position:absolute;left:50%;transform:translateX(-50%);bottom:16px;padding:8px 12px;font-size:12px;color:var(--muted);
    background:var(--glass);border:1px solid rgba(255,255,255,.08);border-radius:999px;backdrop-filter:blur(6px)
  }

  /* Mobil ekran üstü kontroller */
  .controls{
    position:absolute;left:50%;transform:translateX(-50%);bottom:70px;display:none;gap:10px;
  }
  .ctrl{
    min-width:64px;min-height:56px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.03));
    box-shadow:var(--shadow);font-weight:700
  }
  .ctrl:active{transform:translateY(1px) scale(.99)}

  @media (max-width:900px){
    .controls{display:flex}
    .footer{display:none}
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div class="hud" id="hud">
    <div class="stat">Skor: <span id="score">0</span></div>
    <div class="stat muted">•</div>
    <div class="stat">En İyi: <span id="best">0</span></div>
    <div class="chip" id="level">Seviye 1</div>
    <div class="chip" id="fps">FPS</div>
    <div class="btn" id="pauseBtn" title="P / Space">Duraklat</div>
    <div class="btn" id="restartBtn" title="R">Yeniden Başlat</div>
  </div>

  <div class="toolbar">
    Tema:
    <select id="themeSel">
      <option value="neo">Neo</option>
      <option value="neoklasik">NeoKlasik</option>
      <option value="klasik">Klasik</option>
    </select>
  </div>

  <div class="controls">
    <button class="ctrl" id="btnLeft">◀</button>
    <button class="ctrl" id="btnRotate">⟲</button>
    <button class="ctrl" id="btnRight">▶</button>
    <button class="ctrl" id="btnDrop">⬇</button>
  </div>

  <div class="footer">←/→: hareket • ↑/Z/Space: döndür • ↓: hızlı indiriş • P: duraklat • R: yeniden başlat</div>
  <div class="centerNote" id="centerNote">Duraklatıldı</div>
</div>

<script>
/* -------------------- TEMALAR -------------------- */
const THEMES = {
  neo:{
    vars:{'--bg':'#0f1220','--panel':'#171a2b','--text':'#e6e7ee','--muted':'#9aa0b6',
      '--accent':'#7dd3fc','--accent2':'#a78bfa','--glass':'rgba(255,255,255,.06)',
      '--grid-line':'rgba(255,255,255,.06)','--grid-bg1':'rgba(255,255,255,.05)','--grid-bg2':'rgba(255,255,255,.01)',
      '--block-border':'rgba(255,255,255,.25)','--block-flat':'#9bdcff','--block-flat2':'#6aa0ff','--glow':'rgba(125,211,252,1)'},
    blockStyle:'gradientGlow', gridStyle:'softPanel', bg:'dynamicGlow'
  },
  neoklasik:{
    vars:{'--bg':'#0e1117','--panel':'#121622','--text':'#e9eef5','--muted':'#a0a8bd',
      '--accent':'#8bd3ff','--accent2':'#c5b7ff','--glass':'rgba(255,255,255,.05)',
      '--grid-line':'rgba(255,255,255,.08)','--grid-bg1':'rgba(255,255,255,.04)','--grid-bg2':'rgba(255,255,255,.015)',
      '--block-border':'rgba(255,255,255,.18)','--block-flat':'#8dc5ff','--block-flat2':'#7b9bff','--glow':'rgba(180,200,255,1)'},
    blockStyle:'softGradient', gridStyle:'panelLines', bg:'subtleGlow'
  },
  klasik:{
    vars:{'--bg':'#0a0a0a','--panel':'#101010','--text':'#eaeaea','--muted':'#b0b0b0',
      '--accent':'#f0f0f0','--accent2':'#cccccc','--glass':'rgba(255,255,255,.04)',
      '--grid-line':'rgba(255,255,255,.15)','--grid-bg1':'rgba(255,255,255,.02)','--grid-bg2':'rgba(255,255,255,.0)',
      '--block-border':'rgba(0,0,0,.6)','--block-flat':'#e2e2e2','--block-flat2':'#bdbdbd','--glow':'rgba(255,255,255,1)'},
    blockStyle:'flatBorder', gridStyle:'hardLines', bg:'none'
  }
};
function applyTheme(key){
  const t = THEMES[key]||THEMES.neo;
  const root=document.documentElement;
  for(const k in t.vars) root.style.setProperty(k,t.vars[k]);
  localStorage.setItem('tango_theme',key);
}

/* -------------------- OYUN MOTORU -------------------- */
(() => {
  const canvas=document.getElementById('game');
  const ctx=canvas.getContext('2d');
  const hud={
    score:document.getElementById('score'),
    best:document.getElementById('best'),
    level:document.getElementById('level'),
    fps:document.getElementById('fps'),
    pauseBtn:document.getElementById('pauseBtn'),
    restartBtn:document.getElementById('restartBtn'),
    centerNote:document.getElementById('centerNote'),
  };
  const themeSel=document.getElementById('themeSel');

  // Tema yükle
  const savedTheme=localStorage.getItem('tango_theme')||'neo';
  themeSel.value=savedTheme; applyTheme(savedTheme);
  themeSel.addEventListener('change',()=>applyTheme(themeSel.value));

  // DPR / boyut
  const state={width:0,height:0,dpr:1,running:true,last:0,acc:0,fps:0,score:0,lines:0,level:1,best:Number(localStorage.getItem('tango_best')||0)};
  hud.best.textContent=state.best;
  function resize(){
    const {clientWidth:w,clientHeight:h}=canvas.parentElement;
    const dpr=Math.min(window.devicePixelRatio||1,2);
    canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
    canvas.style.width=w+'px'; canvas.style.height=h+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    state.width=w; state.height=h; centerGrid();
  }
  addEventListener('resize',resize,{passive:true}); resize();

  // Grid
  const GRID={cols:10,rows:20,cell:36,originX:0,originY:0};
  function centerGrid(){
    const w=GRID.cols*GRID.cell, h=GRID.rows*GRID.cell;
    GRID.originX=Math.floor(state.width/2-w/2);
    GRID.originY=Math.floor(state.height/2-h/2);
  }
  const board=Array.from({length:GRID.rows},()=>Array(GRID.cols).fill(0));

  // Giriş
  const input={left:false,right:false,rot:false,drop:false,soft:false};
  addEventListener('keydown',e=>{
    if(e.repeat) return;
    if(e.code==='ArrowLeft'||e.code==='KeyA') input.left=true;
    if(e.code==='ArrowRight'||e.code==='KeyD') input.right=true;
    if(['ArrowUp','KeyZ','Space'].includes(e.code)) input.rot=true;
    if(e.code==='ArrowDown'||e.code==='KeyS') input.soft=true;
    if(e.code==='ShiftLeft'||e.code==='ShiftRight') input.drop=true;
    if(e.code==='KeyP') togglePause();
    if(e.code==='KeyR') restart();
  });
  addEventListener('keyup',e=>{
    if(e.code==='ArrowLeft'||e.code==='KeyA') input.left=false;
    if(e.code==='ArrowRight'||e.code==='KeyD') input.right=false;
    if(['ArrowUp','KeyZ','Space'].includes(e.code)) input.rot=false;
    if(e.code==='ArrowDown'||e.code==='KeyS') input.soft=false;
    if(e.code==='ShiftLeft'||e.code==='ShiftRight') input.drop=false;
  });

  // Ekran üstü mobil butonları
  const btnL=document.getElementById('btnLeft');
  const btnR=document.getElementById('btnRight');
  const btnRot=document.getElementById('btnRotate');
  const btnDrop=document.getElementById('btnDrop');
  function tap(el,fn){ el.addEventListener('touchstart',e=>{e.preventDefault();fn();},{passive:false}); el.addEventListener('click',fn); }
  tap(btnL,()=> stepLeft());
  tap(btnR,()=> stepRight());
  tap(btnRot,()=> rotatePiece());
  tap(btnDrop,()=> hardDrop());

  // Dokunma jestleri: sola/sağa sürükle hareket; aşağı hızlı indiriş; tek dokunma döndür
  let touchStart=null;
  canvas.addEventListener('touchstart',e=>{
    const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY,time:performance.now()};
  },{passive:true});
  canvas.addEventListener('touchend',e=>{
    if(!touchStart) return;
    const t=e.changedTouches[0];
    const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y;
    const adx=Math.abs(dx), ady=Math.abs(dy);
    const dt=performance.now()-touchStart.time;
    if(adx>40 && adx>ady){ if(dx>0) stepRight(); else stepLeft(); }
    else if(ady>40 && ady>adx){ if(dy>0) softDrop(); }
    else if(dt<250){ rotatePiece(); } // kısa dokunma: döndür
    touchStart=null;
  },{passive:true});

  hud.pauseBtn.addEventListener('click',togglePause);
  hud.restartBtn.addEventListener('click',restart);
  function togglePause(){ state.running=!state.running; hud.centerNote.textContent=state.running?'':'Duraklatıldı'; hud.centerNote.style.display=state.running?'none':'block'; }

  // Şekiller + dönüş
  const SHAPES={
    I:[[1,1,1,1]],
    O:[[1,1],[1,1]],
    T:[[0,1,0],[1,1,1]],
    J:[[1,0,0],[1,1,1]],
    L:[[0,0,1],[1,1,1]],
    S:[[0,1,1],[1,1,0]],
    Z:[[1,1,0],[0,1,1]],
  };
  const KEYS=Object.keys(SHAPES);
  function rotate(mat){
    const h=mat.length,w=mat[0].length;
    const out=Array.from({length:w},()=>Array(h).fill(0));
    for(let r=0;r<h;r++) for(let c=0;c<w;c++) out[c][h-1-r]=mat[r][c];
    return out;
  }

  function newPiece(){
    const k=KEYS[Math.floor(Math.random()*KEYS.length)];
    const shape=SHAPES[k].map(r=>r.slice());
    const w=shape[0].length,h=shape.length;
    const hues=[200,220,250,280,300]; const base=hues[Math.floor(Math.random()*hues.length)];
    return{
      x:Math.floor(GRID.cols/2-w/2), y:-h, shape, type:k,
      fallTimer:0, fallRate:0.7,
      c1:`hsl(${base} 90% 66%)`, c2:`hsl(${base+20} 90% 56%)`
    };
  }
  let piece=newPiece(), gameOver=false;

  function collide(px,py,shape){
    for(let r=0;r<shape.length;r++) for(let c=0;c<shape[r].length;c++){
      if(!shape[r][c]) continue;
      const x=px+c, y=py+r;
      if(x<0||x>=GRID.cols||y>=GRID.rows) return true;
      if(y>=0 && board[y][x]) return true;
    }
    return false;
  }

  function lockPiece(){
    const {x:px,y:py,shape}=piece;
    for(let r=0;r<shape.length;r++) for(let c=0;c<shape[r].length;c++){
      if(!shape[r][c]) continue;
      const x=px+c,y=py+r; if(y>=0) board[y][x]=1;
    }
    const cleared=clearLines();
    if(cleared){
      state.lines+=cleared;
      const add = [0,100,250,450,700][cleared] || cleared*300;
      addScore(add);
      // seviye artışı her 10 satırda
      const newLevel=Math.floor(state.lines/10)+1;
      if(newLevel>state.level){ state.level=newLevel; hud.level.textContent='Seviye '+state.level; }
    }
    piece=newPiece();
    if(collide(piece.x,piece.y,piece.shape)){ gameOver=true; showCenter('Oyun Bitti • Space/Enter ile yeniden başla'); }
  }

  function clearLines(){
    let cleared=0;
    for(let r=GRID.rows-1;r>=0;r--){
      if(board[r].every(v=>v===1)){ board.splice(r,1); board.unshift(Array(GRID.cols).fill(0)); cleared++; spawnClearParticles(r); r++; }
    }
    return cleared;
  }

  // Skor / kayıt
  function addScore(n){
    state.score+=n; hud.score.textContent=state.score;
    if(state.score>state.best){ state.best=state.score; hud.best.textContent=state.best; localStorage.setItem('tango_best',state.best); }
  }

  // Parçacıklar
  const particles=[];
  function spawnClearParticles(row){
    const y=GRID.originY+row*GRID.cell+GRID.cell/2;
    for(let i=0;i<80;i++){
      particles.push({x:GRID.originX+Math.random()*GRID.cols*GRID.cell,y,
        vx:(Math.random()*240-120),vy:(-240-Math.random()*120),life:.4+Math.random()*.5,age:0,size:2+Math.random()*3});
    }
  }
  function updateParticles(dt){
    for(const p of particles){ p.age+=dt; p.vy+=900*dt; p.x+=p.vx*dt; p.y+=p.vy*dt; }
    for(let i=particles.length-1;i>=0;i--) if(particles[i].age>particles[i].life) particles.splice(i,1);
  }
  function drawParticles(g){
    g.save(); g.globalCompositeOperation='lighter';
    const acc=getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#7dd3fc';
    for(const p of particles){ const a=1-(p.age/p.life); g.globalAlpha=a; g.fillStyle=acc; g.fillRect(p.x,p.y,p.size,p.size); }
    g.restore(); g.globalAlpha=1;
  }

  // Arka plan
  function drawBG(g){
    const w=state.width,h=state.height; const theme=localStorage.getItem('tango_theme')||'neo';
    if(THEMES[theme].bg==='dynamicGlow'){
      const t=performance.now()*0.0004; const cx=w*(0.5+Math.sin(t)*0.2), cy=h*(0.4+Math.cos(t*0.9)*0.15);
      const rad=Math.max(w,h)*0.8; const grd=g.createRadialGradient(cx,cy,rad*0.1,cx,cy,rad);
      grd.addColorStop(0,'rgba(167,139,250,.12)'); grd.addColorStop(1,'rgba(0,0,0,0)'); g.fillStyle=grd; g.fillRect(0,0,w,h);
    } else if(THEMES[theme].bg==='subtleGlow'){
      const grd=g.createRadialGradient(w*.7,h*.2,10,w*.7,h*.2,Math.max(w,h)*.7);
      grd.addColorStop(0,'rgba(200,220,255,.08)'); grd.addColorStop(1,'rgba(0,0,0,0)'); g.fillStyle=grd; g.fillRect(0,0,w,h);
    }
  }

  // Çizim yardımcıları
  function rr(g,x,y,w,h,r=8){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath(); }
  function fillGrad(g,x,y,w,h,c1,c2){ const grad=g.createLinearGradient(x,y,x+w,y+h); grad.addColorStop(0,c1); grad.addColorStop(1,c2); g.fillStyle=grad; g.fill(); }
  function glow(g,x,y,w,h,a){ g.save(); g.shadowColor=getComputedStyle(document.documentElement).getPropertyValue('--glow')||'rgba(125,211,252,1)'; g.shadowBlur=30*a; g.globalAlpha=.9*a; rr(g,x,y,w,h,10); g.fillStyle='rgba(125,211,252,.15)'; g.fill(); g.restore(); g.globalAlpha=1; }
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  // Grid çizimi
  function drawGrid(g){
    const ox=GRID.originX, oy=GRID.originY, cs=GRID.cell, w=GRID.cols*cs, h=GRID.rows*cs;
    const theme=localStorage.getItem('tango_theme')||'neo';
    rr(g,ox-10,oy-10,w+20,h+20,16);
    if(THEMES[theme].gridStyle==='softPanel'){
      fillGrad(g,ox-10,oy-10,w+20,h+20,getVar('--grid-bg1'),getVar('--grid-bg2')); glow(g,ox-10,oy-10,w+20,h+20,.6);
    }else if(THEMES[theme].gridStyle==='panelLines'){
      fillGrad(g,ox-10,oy-10,w+20,h+20,getVar('--grid-bg1'),getVar('--grid-bg2'));
    }else{
      g.fillStyle='rgba(255,255,255,.04)'; g.fill();
    }
    // çizgiler
    g.save(); g.strokeStyle=getVar('--grid-line'); g.lineWidth=1;
    for(let c=0;c<=GRID.cols;c++){ const x=ox+c*cs; g.beginPath(); g.moveTo(x,oy); g.lineTo(x,oy+h); g.stroke(); }
    for(let r=0;r<=GRID.rows;r++){ const y=oy+r*cs; g.beginPath(); g.moveTo(ox,y); g.lineTo(ox+w,y); g.stroke(); }
    g.restore();

    // yerleşik bloklar
    for(let r=0;r<GRID.rows;r++) for(let c=0;c<GRID.cols;c++) if(board[r][c]) drawBlock(g,ox+c*cs,oy+r*cs,cs,cs,theme,'#93c5fd','#a78bfa');
  }

  function drawBlock(g,x,y,w,h,theme,c1,c2){
    const style=THEMES[theme].blockStyle; const pad=3,r=8;
    rr(g,x+pad,y+pad,w-pad*2,h-pad*2,r);
    if(style==='gradientGlow'){
      fillGrad(g,x+pad,y+pad,w-pad*2,h-pad*2,c1,c2); glow(g,x+pad,y+pad,w-pad*2,h-pad*2,.5);
      g.save(); g.globalAlpha=.35; g.strokeStyle=getVar('--block-border'); g.lineWidth=1; g.stroke(); g.restore();
    }else if(style==='softGradient'){
      fillGrad(g,x+pad,y+pad,w-pad*2,h-pad*2,c1,c2);
      g.save(); g.globalAlpha=.25; g.strokeStyle=getVar('--block-border'); g.lineWidth=1; g.stroke(); g.restore();
    }else{
      g.fillStyle=getVar('--block-flat'); g.fill();
      g.save(); g.strokeStyle=getVar('--block-border'); g.lineWidth=2; g.stroke(); g.restore();
      g.save(); g.globalAlpha=.08; g.fillStyle='#fff'; rr(g,x+pad,y+pad,(w-pad*2),(h-pad*2)/2,r); g.fill(); g.restore();
    }
  }

  // Aktif taş
  function drawPiece(g){
    const ox=GRID.originX, oy=GRID.originY, cs=GRID.cell;
    const theme=localStorage.getItem('tango_theme')||'neo';
    for(let r=0;r<piece.shape.length;r++) for(let c=0;c<piece.shape[r].length;c++)
      if(piece.shape[r][c]) drawBlock(g,ox+(piece.x+c)*cs,oy+(piece.y+r)*cs,cs,cs,theme,piece.c1,piece.c2);

    // Hayalet
    g.save(); g.globalAlpha=.12;
    let py=piece.y; while(!collide(piece.x,py+1,piece.shape)) py++;
    for(let r=0;r<piece.shape.length;r++) for(let c=0;c<piece.shape[r].length;c++)
      if(piece.shape[r][c]) drawBlock(g,ox+(piece.x+c)*cs,oy+(py+r)*cs,cs,cs,theme,'#ffffff','#ffffff');
    g.restore();
  }

  // Hareket yardımcıları (duvar vuruşu ile)
  function stepLeft(){ if(!collide(piece.x-1,piece.y,piece.shape)) piece.x--; }
  function stepRight(){ if(!collide(piece.x+1,piece.y,piece.shape)) piece.x++; }
  function rotatePiece(){
    const rot=rotate(piece.shape);
    if(!collide(piece.x,piece.y,rot)){ piece.shape=rot; return; }
    if(!collide(piece.x-1,piece.y,rot)){ piece.x--; piece.shape=rot; return; }
    if(!collide(piece.x+1,piece.y,rot)){ piece.x++; piece.shape=rot; return; }
  }
  function softDrop(){
    if(!collide(piece.x,piece.y+1,piece.shape)){ piece.y++; addScore(1); }
    else lockPiece();
  }
  function hardDrop(){
    let steps=0;
    while(!collide(piece.x,piece.y+1,piece.shape)){ piece.y++; steps++; }
    addScore(steps*2);
    lockPiece();
  }

  function showCenter(msg){ hud.centerNote.textContent=msg; hud.centerNote.style.display='block'; }
  function hideCenter(){ hud.centerNote.style.display='none'; }
  function restart(){
    for(let r=0;r<GRID.rows;r++) for(let c=0;c<GRID.cols;c++) board[r][c]=0;
    piece=newPiece(); state.score=0; hud.score.textContent=0; state.lines=0; state.level=1; hud.level.textContent='Seviye 1';
    particles.length=0; gameOver=false; hideCenter();
  }

  // Oyun döngüsü
  const FIXED=1/60;
  function update(dt){
    if(!gameOver){
      if(input.left){ stepLeft(); input.left=false; }
      if(input.right){ stepRight(); input.right=false; }
      if(input.rot){ rotatePiece(); input.rot=false; }
      if(input.drop){ hardDrop(); input.drop=false; }
      if(input.soft){ piece.fallTimer += dt*4; } // aşağı basılı tutma = hızlandırma

      // seviye hızı
      const speedBase=Math.max(0.12, 0.7 - (state.level-1)*0.06);
      piece.fallTimer += dt;
      if(piece.fallTimer>=speedBase){
        piece.fallTimer=0;
        if(!collide(piece.x,piece.y+1,piece.shape)) piece.y++;
        else lockPiece();
      }
    }
    updateParticles(dt);
  }

  function draw(){
    ctx.clearRect(0,0,state.width,state.height);
    drawBG(ctx);
    drawGrid(ctx);
    drawPiece(ctx);
    drawParticles(ctx);
  }

  const FIX=1/60;
  function loop(t){
    const ts=t*0.001; const dtRaw=state.last?(ts-state.last):FIX;
    state.last=ts; state.fps=Math.round(1/Math.max(0.001,dtRaw)); hud.fps.textContent=state.fps+' FPS';
    if(state.running){
      state.acc+=dtRaw; let steps=0; while(state.acc>=FIX && steps<5){ update(FIX); state.acc-=FIX; steps++; }
      draw();
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Space/Enter ile yeniden başlat bitimde
  addEventListener('keydown',e=>{ if(gameOver && (e.code==='Space'||e.code==='Enter')) restart(); });

})();
</script>
</body>
</html>